<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Heatmaps</title>
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
      #panel {
        position: absolute;
        top: 5px;
        left: 45%;
        transform: translate(-50%, 0%);
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
      }
      #word_count_chart {
          position: absolute;
          z-index: 2;
          bottom: 0;
          width: 95%;
          height: 120px;
      }
    </style>
    <script src="//code.jquery.com/jquery-latest.min.js"></script>
    <script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
    <script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script type="text/javascript" src="../static/js/epoch.min.js"></script>
    <link rel="stylesheet" type="text/css" href="../static/css/epoch.min.css">
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true&libraries=visualization"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.16/socket.io.min.js"></script>

    <script>
      var map, heatmap;
      var markerFlag = null;
      var markers = [];
      var socket1 = null;
      var currentKeyword = null;
      var tweetPoints = null;
      var SOCKET_ADDR = 'http://' + document.domain + ':' + location.port;

      function processOneTweet(tweet_parsed_json) {
        // add latlon to heatmap
        var newLatLon = new google.maps.LatLng(tweet_parsed_json.lat, tweet_parsed_json.lon);
        tweetPoints.push(newLatLon);
        // process markers
        var marker = new google.maps.Marker({
          position: newLatLon,
          map: markerFlag
        });
        markers.push(marker);
        var iw = new google.maps.InfoWindow({content: tweet_parsed_json.text});
        google.maps.event.addListener(marker, "click", function (e) { iw.open(map, this); });
      }

      function initialize() {
        var mapOptions = {
          zoom: 3,
          center: new google.maps.LatLng(37.774546, -122.433523),
          mapTypeId: google.maps.MapTypeId.MAP
        };

        map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
        markers = [];
        // fetch data and create inital heat map
        tweetPoints = new google.maps.MVCArray();
        $.getJSON("/api/history/keyword/", function(data){
          $.each(data,function(i,tweet) {
            processOneTweet(tweet);
          });
          heatmap = new google.maps.visualization.HeatmapLayer({
            map: map,
            data: tweetPoints,
            radius: 40
          });
        });
      }

      function submitUserChoice()
      {
        var mode = $("#mode option:selected").val();
        var keyword = $("#keyword").val()
        hideMarkers();
        markers = [];
        if (socket1 != null)
        {
          socket1.disconnect();
          socket1 = null;
        }
        if (mode=="history")
          handleHistory(keyword);
        else if (mode=="realtime")
          handleRealtime(keyword);
        else
          alert("Illegal choice!");
      }

      function handleHistory(keyword)
      {
        tweetPoints = new google.maps.MVCArray();
        $.getJSON("/api/history/keyword/"+keyword, function(data){
          $.each(data,function(i,tweet) {
            processOneTweet(tweet);
          });
          heatmap.setData(tweetPoints);
        });
      }

      function handleRealtime(keyword)
      {
        $('#heatmap_pause_resume').val("Pause");
        tweetPoints = new google.maps.MVCArray();
        heatmap.setData(tweetPoints);
        // alert(SOCKET_ADDR);
        socket1 = io.connect(SOCKET_ADDR, {'force new connection':true });
        currentKeyword = keyword;
        socket1.emit('keyword', currentKeyword);
        socket1.on('data_transfer', function(data) {
          // alert(data);
          // console.log(data);
          parsedTweet = $.parseJSON(data);
          processOneTweet(parsedTweet);
        });
        socket1.on('die1', function(exception) {
          alert(exception);
          socket1.disconnect();
          socket1 = null;
          currentKeyword = null;
        });
      }

      $(function() {  // toggle markers
        $('#toggleMarkers').click(function() {
          $(this).val() == "Show markers" ? showMarkers() : hideMarkers();
        });
      });

      $(function() {  // toggle heatmap
        $('#toggleHeatmap').click(function() {
          $(this).val() == "Show heatmap" ? showHeatmap() : hideHeatmap();
        });
      });

      $(function() {  // toggle pause/resume
        $('#heatmap_pause_resume').click(function() {
          $(this).val() == "Resume" ? resumeHeatmap() : pauseHeatmap();
        });
      });

      function setAllMap(map) {
        for (var i = 0; i < markers.length; i++) {
          markers[i].setMap(map);
        }
      }

      function hideMarkers()
      {
        $('#toggleMarkers').val("Show markers");
        setAllMap(null);
        markerFlag = null;
      }

      function showMarkers() {
        $('#toggleMarkers').val("Hide markers");
        setAllMap(map);
        markerFlag = map;
      }

      function hideHeatmap() {
        $('#toggleHeatmap').val("Show heatmap");
        heatmap.setMap(null);
      }

      function showHeatmap() {
        $('#toggleHeatmap').val("Hide heatmap");
        heatmap.setMap(map);
      }

      function pauseHeatmap() {
        if (socket1 != null)
        {
          $('#heatmap_pause_resume').val("Resume");
          socket1.disconnect();
          socket1 = null;
        }
      }

      function resumeHeatmap() {
        if(socket1 == null && currentKeyword != null)
        {
          $('#heatmap_pause_resume').val("Pause");
          socket1 = io.connect(SOCKET_ADDR, {'force new connection':true });
          socket1.emit('keyword', currentKeyword);
          socket1.on('data_transfer', function(data) {
            // alert(data);
            // console.log(data);
            parsedTweet = $.parseJSON(data);
            processOneTweet(parsedTweet);
          });
        }
      }

      google.maps.event.addDomListener(window, 'load', initialize);
      

    </script>
  </head>

  <body>
    <div id="panel">
      <select id="mode">
        <option value="realtime">Show real time data</option>
        <option value="history">Show history data</option>
      </select>
      Keyword: <input id="keyword" type="text" value="">
      <button type="submit" onclick="submitUserChoice()">Show tweets</button>
      <input type="button" id="heatmap_pause_resume" value="Pause"/>
      <input type="button" id="toggleMarkers" value="Show markers"/>
      <input type="button" id="toggleHeatmap" value="Hide heatmap"/>
    </div>
    <div id="word_count_chart" class="epoch"></div>
    <div id="map-canvas"></div>
    <script type="text/javascript">
      var socket2 = null;
      var chart;
      var timestamp = ((new Date()).getTime() / 1000)|0;
      var config_table = {};

      $(function(){
        // $.when(getInitConfig()).then(startBarChart());
        getInitConfig();
      });

      function getInitConfig()
      {
        $.getJSON("/config", function(data){
          $.each(data,function(key,value) {
            config_table[key] = value;
            if (key=="selected_countries")  // not the optimal way to do func2 after func1. investigate promise.done 
              startBarChart();
          });
        });
      }

      function startBarChart()
      {
        // console.log(config_table);
        chart = $('#word_count_chart')
          .epoch({
            type: 'time.bar',
            data: getInitBarData(),
            axes: ['left', 'bottom', 'right']
          });
        getWordCount();
      }

      function getInitBarData()
      {
        var selected_countries = config_table["selected_countries"];
        var initBarData = [];
        for (var i = 0; i < selected_countries.length; i++) {
          initBarData.push({values: [{time: timestamp, y: 0}]});
        };
        return initBarData;
      }

      function getWordCount()
      {
        if (socket2 != null)
        {
          socket2.disconnect();
          socket2 = null;
        }
        // alert(SOCKET_ADDR);
        socket2 = io.connect(SOCKET_ADDR, {'force new connection':true });
        socket2.emit('word_count_and_stats_c2s', '');
        socket2.on('word_count_and_stats_s2c', function(data) {  // {"US": [123, {"a": 1, "h": 1, "p": 1, "s": 1, "u": 1, "t": 1, "w": 1}]}
          // console.log(typeof data);
          // console.log(data)
          timestamp++;
          var entry = [];
          data = $.parseJSON(data);
          var selected_countries = config_table["selected_countries"];
          for (var i = 0; i < selected_countries.length; i++)
          {
            var country_code = selected_countries[i];
            if(country_code in data)
            {
              var total_word_count = data[country_code][0];
              // var word_stats = data[country_code][1];
              entry.push({time:timestamp, y:total_word_count});
            }
            else
            {
              entry.push({time:timestamp, y:0});
            }
          }
          chart.push(entry);
        });

        socket2.on('die2', function(exception) {
          alert(exception);
          socket2.disconnect();
          socket2 = null;
        });
      }

    </script>
  </body>
</html>